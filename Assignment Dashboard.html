<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assignment Dashboard</title>
  <style>
    :root {
      --bg: #fff;
      --text: #111;
      --muted: #555;
      --border: #ddd;
      --card-bg: #fff;
      --pill-bg: #fafafa;
      --bar-track: #f1f1f1;
      --bar-fill: #F4C2C2;
      --warn: #b00020;
    }
    [data-theme="dark"] {
      --bg: #1a1a1a;
      --text: #e8e8e8;
      --muted: #aaa;
      --border: #444;
      --card-bg: #252525;
      --pill-bg: #333;
      --bar-track: #333;
      --bar-fill: #c97b8a;
      --warn: #ef5350;
    }
    body { font-family: "Times New Roman", Times, serif; margin: 24px; max-width: 980px; background: var(--bg); color: var(--text); }
    h1 { margin: 0 0 6px; }
    .muted { color: var(--muted); margin: 0 0 14px; }
    .top { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    button { padding: 10px 12px; cursor: pointer; background: var(--pill-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
    button:hover { filter: brightness(1.1); }
    .pill { display:inline-block; padding: 6px 10px; border:1px solid var(--border); border-radius: 999px; background: var(--pill-bg); }
    .cards { display:grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap:10px; margin-top: 14px; }
    .card { border:1px solid var(--border); border-radius: 14px; padding: 12px; background: var(--card-bg); }
    .big { font-size: 20px; font-weight: 800; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: left; vertical-align: middle; }
    .bar { height: 12px; background: var(--bar-track); border-radius: 999px; overflow: hidden; }
    .bar > div { height: 100%; background: var(--bar-fill); width: 0%; }
    .right { text-align: right; }
    .warn { color: var(--warn); }
    .section-title { font-size: 1.1em; font-weight: 700; margin: 24px 0 10px; }
    .per-day-table { margin-top: 6px; }
    .goals-add { border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-top: 12px; max-width: 480px; background: var(--card-bg); }
    .goals-add .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    .goals-add label { min-width: 80px; }
    .goals-add input[type="date"], .goals-add select { padding: 8px 10px; font-family: inherit; background: var(--pill-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; }
    .goals-list { display: flex; flex-direction: column; gap: 10px; margin-top: 12px; }
    .goal-card { border: 1px solid var(--border); border-radius: 14px; padding: 12px 16px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; background: var(--card-bg); }
    .goal-card .goal-info { flex: 1; min-width: 200px; }
    .goal-card .goal-info strong { display: block; margin-bottom: 4px; }
    .goal-card .goal-remove { padding: 6px 10px; cursor: pointer; }
    .header-row { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 8px; }
    .header-left { flex: 1; min-width: 0; }
    .theme-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .theme-controls select { padding: 6px 10px; font-family: inherit; background: var(--pill-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; }
    .preference-colors { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .preference-colors label { font-size: 12px; color: var(--muted); margin-right: 2px; }
    .preference-colors input[type="color"] { width: 28px; height: 28px; padding: 0; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: transparent; }
    .preference-colors.hidden { display: none; }
    .grade-header { white-space: nowrap; }
    .grade-header .grade-format-switch { margin-left: 6px; padding: 2px 6px; font-size: 12px; font-family: inherit; background: var(--pill-bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }
    .tabs { display: flex; gap: 4px; margin: 14px 0 0; }
    .tabs button { padding: 8px 16px; cursor: pointer; background: var(--pill-bg); color: var(--text); border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; }
    .tabs button.active { background: var(--bar-fill); border-color: var(--bar-fill); font-weight: 600; }
    .tabs button:hover:not(.active) { filter: brightness(1.05); }
    .tab-panel { margin-top: 14px; }
    .tab-panel.hidden { display: none; }
    .charts-row { display: flex; flex-wrap: wrap; gap: 24px; margin-top: 16px; align-items: flex-start; }
    .chart-card { border: 1px solid var(--border); border-radius: 14px; padding: 16px; background: var(--card-bg); }
    .chart-card h3 { margin: 0 0 12px; font-size: 1em; }
    .pie-wrap { width: 260px; height: 260px; border-radius: 50%; margin: 0 auto 12px; }
    .chart-legend { font-size: 13px; color: var(--muted); }
    .chart-legend span { display: inline-block; margin-right: 12px; margin-bottom: 4px; }
    .chart-legend .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
  </style>
</head>
<body>
  <div class="header-row">
    <div class="header-left">
      <h1>Assignment Dashboard</h1>
      <p class="muted">Reads <span class="pill">gradebook-progress.json</span> from this folder.</p>
    </div>
    <div class="theme-controls">
      <select id="themeSelect" title="Theme">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="preference">Preference</option>
      </select>
      <div id="preferenceColors" class="preference-colors hidden">
        <label>Bg</label><input type="color" id="prefBg" value="#ffffff" title="Background" />
        <label>Text</label><input type="color" id="prefText" value="#111111" title="Text" />
        <label>Muted</label><input type="color" id="prefMuted" value="#555555" title="Muted text" />
        <label>Border</label><input type="color" id="prefBorder" value="#dddddd" title="Borders" />
        <label>Card</label><input type="color" id="prefCard" value="#ffffff" title="Card background" />
        <label>Bar</label><input type="color" id="prefBar" value="#F4C2C2" title="Progress bar fill" />
      </div>
    </div>
  </div>

  <div class="top">
    <button id="refreshBtn">Refresh from file</button>
    <button onclick="window.print()">Print / Save PDF</button>
    <button id="importBtn">Import downloaded JSON</button>
    <input id="fileInput" type="file" accept="application/json" style="display:none" />
    <span class="pill">Last update: <strong id="lastUpdate">—</strong></span>
    <span class="pill">Status: <span id="status">—</span></span>
  </div>

  <div class="tabs">
    <button type="button" id="tabDashboard" class="active">Dashboard</button>
    <button type="button" id="tabCharts">Charts</button>
  </div>

  <div id="dashboardPanel" class="tab-panel">
  <div class="cards">
    <div class="card"><div class="muted">Courses</div><div class="big" id="numCourses">—</div></div>
    <div class="card"><div class="muted">Assignments left (sum)</div><div class="big" id="sumLeft">—</div></div>
    <div class="card"><div class="muted">Total assignments (sum)</div><div class="big" id="sumTotal">—</div></div>
    <div class="card"><div class="muted">Overall % complete</div><div class="big" id="overallPct">—</div></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Course</th>
        <th>End date</th>
        <th class="grade-header">
          <span>Grade</span>
          <select id="gradeFormatSelect" class="grade-format-switch" title="Standard: letter only (A, B, C, D, F). Epic Charter Schools uses this. College: plus/minus scale (A+, A, A-, B+, B, B-, etc.) for finer distinction.">
            <option value="standard">Standard</option>
            <option value="college">College</option>
          </select>
        </th>
        <th>Progress</th>
        <th>Completed</th>
        <th>Left</th>
        <th style="width: 240px;">Bar</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <h2 class="section-title">Per day (to complete on time)</h2>
  <table class="per-day-table">
    <thead>
      <tr><th>Course</th><th>All days</th><th>Work week</th><th>Per day</th></tr>
    </thead>
    <tbody id="perDayBody"></tbody>
  </table>

  <h2 class="section-title">Goals</h2>
  <div class="goals-add">
    <div class="row">
      <label for="goalCourse">Subject</label>
      <select id="goalCourse"><option value="">— Select course —</option></select>
    </div>
    <div class="row">
      <label for="goalDate">Finish by</label>
      <input type="date" id="goalDate" />
    </div>
    <div class="row">
      <button type="button" id="addGoalBtn">Add goal</button>
    </div>
  </div>
  <div id="goalsList" class="goals-list"></div>
  </div>

  <div id="chartsPanel" class="tab-panel hidden">
    <div class="charts-row">
      <div class="chart-card">
        <h3>Completed vs remaining</h3>
        <div id="pieCompletedVsRemaining" class="pie-wrap"></div>
        <div id="legendCompletedVsRemaining" class="chart-legend"></div>
      </div>
      <div class="chart-card">
        <h3>Remaining per course (%)</h3>
        <div id="pieRemainingPerCourse" class="pie-wrap"></div>
        <div id="legendRemainingPerCourse" class="chart-legend"></div>
      </div>
    </div>
  </div>

<script>
    document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("fileInput").click();
    });

    document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  const txt = await file.text();
  const data = JSON.parse(txt);
  render(data);              // uses your existing render()
  setStatus("Imported ✅");
  e.target.value = "";       // allow re-importing same file later
});

  const JSON_FILE = "gradebook-progress.json";
  const STORAGE_KEY = "gradebook-progress-cache";
  const GOAL_STORAGE_KEY = "gradebook-goal";
  const THEME_STORAGE_KEY = "dashboard-theme";
  const GRADE_FORMAT_KEY = "dashboard-grade-format";
  const THEME_PREFERENCE_KEY = "dashboard-theme-preference";

  const defaultPreference = { bg: "#ffffff", text: "#111111", muted: "#555555", border: "#dddddd", card: "#ffffff", bar: "#F4C2C2" };

  function loadTheme() {
    try { return localStorage.getItem(THEME_STORAGE_KEY) || "light"; } catch (e) { return "light"; }
  }
  function saveTheme(mode) {
    try { localStorage.setItem(THEME_STORAGE_KEY, mode); } catch (e) {}
  }
  function loadPreferenceColors() {
    try {
      const raw = localStorage.getItem(THEME_PREFERENCE_KEY);
      return raw ? { ...defaultPreference, ...JSON.parse(raw) } : { ...defaultPreference };
    } catch (e) { return { ...defaultPreference }; }
  }
  function savePreferenceColors(pref) {
    try { localStorage.setItem(THEME_PREFERENCE_KEY, JSON.stringify(pref)); } catch (e) {}
  }
  function applyTheme(mode, pref) {
    const root = document.documentElement;
    root.removeAttribute("data-theme");
    root.style.removeProperty("--bg");
    root.style.removeProperty("--text");
    root.style.removeProperty("--muted");
    root.style.removeProperty("--border");
    root.style.removeProperty("--card-bg");
    root.style.removeProperty("--pill-bg");
    root.style.removeProperty("--bar-track");
    root.style.removeProperty("--bar-fill");
    root.style.removeProperty("--warn");
    if (mode === "dark") root.setAttribute("data-theme", "dark");
    else if (mode === "preference" && pref) {
      root.style.setProperty("--bg", pref.bg);
      root.style.setProperty("--text", pref.text);
      root.style.setProperty("--muted", pref.muted);
      root.style.setProperty("--border", pref.border);
      root.style.setProperty("--card-bg", pref.card);
      root.style.setProperty("--pill-bg", pref.card);
      root.style.setProperty("--bar-track", pref.border);
      root.style.setProperty("--bar-fill", pref.bar);
      root.style.setProperty("--warn", "#b00020");
    }
  }
  function initTheme() {
    const mode = loadTheme();
    const pref = loadPreferenceColors();
    const sel = document.getElementById("themeSelect");
    const panel = document.getElementById("preferenceColors");
    if (sel) sel.value = mode;
    if (panel) panel.classList.toggle("hidden", mode !== "preference");
    document.getElementById("prefBg").value = pref.bg;
    document.getElementById("prefText").value = pref.text;
    document.getElementById("prefMuted").value = pref.muted;
    document.getElementById("prefBorder").value = pref.border;
    document.getElementById("prefCard").value = pref.card;
    document.getElementById("prefBar").value = pref.bar;
    applyTheme(mode, pref);
  }
  function onThemeChange() {
    const mode = document.getElementById("themeSelect").value;
    saveTheme(mode);
    document.getElementById("preferenceColors").classList.toggle("hidden", mode !== "preference");
    const pref = mode === "preference" ? loadPreferenceColors() : null;
    applyTheme(mode, pref);
  }
  function onPreferenceColorChange() {
    const pref = {
      bg: document.getElementById("prefBg").value,
      text: document.getElementById("prefText").value,
      muted: document.getElementById("prefMuted").value,
      border: document.getElementById("prefBorder").value,
      card: document.getElementById("prefCard").value,
      bar: document.getElementById("prefBar").value
    };
    savePreferenceColors(pref);
    if (loadTheme() === "preference") applyTheme("preference", pref);
  }
  initTheme();
  document.getElementById("themeSelect").addEventListener("change", onThemeChange);
  ["prefBg","prefText","prefMuted","prefBorder","prefCard","prefBar"].forEach(id => {
    document.getElementById(id).addEventListener("input", onPreferenceColorChange);
    document.getElementById(id).addEventListener("change", onPreferenceColorChange);
  });

  function cleanText(s){ return (s || "").toString().replace(/\s+/g," ").trim(); }

  function saveToStorage(data) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) { console.warn("Could not save to storage", e); }
  }

  function loadFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch (e) { return null; }
  }

  function loadGoals() {
    try {
      const raw = localStorage.getItem(GOAL_STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : (parsed.courseName ? [parsed] : []);
    } catch (e) { return []; }
  }

  function saveGoals(goals) {
    try {
      if (!goals || goals.length === 0) localStorage.removeItem(GOAL_STORAGE_KEY);
      else localStorage.setItem(GOAL_STORAGE_KEY, JSON.stringify(goals));
    } catch (e) { console.warn("Could not save goals", e); }
  }

  function addGoal() {
    const sel = document.getElementById("goalCourse");
    const dateInput = document.getElementById("goalDate");
    const idx = sel?.value;
    const finishBy = dateInput?.value;
    if (!idx || !finishBy) return;
    const c = lastCourses[Number(idx)];
    if (!c) return;
    const goals = loadGoals();
    if (goals.some(g => (g.courseName || "") === (c.course || "") && (g.finishBy || "") === finishBy)) return;
    goals.push({ courseName: c.course, finishBy });
    saveGoals(goals);
    renderGoalCards();
    if (sel) sel.value = "";
    if (dateInput) dateInput.value = "";
  }

  function removeGoal(index) {
    const goals = loadGoals();
    goals.splice(index, 1);
    saveGoals(goals);
    renderGoalCards();
  }

  function renderGoalCards() {
    const container = document.getElementById("goalsList");
    if (!container) return;
    const goals = loadGoals();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    container.innerHTML = "";
    goals.forEach((g, i) => {
      const c = lastCourses.find(x => (x.course || "") === (g.courseName || ""));
      const finishBy = g.finishBy || "";
      let subtitle = "Finish by " + (finishBy ? new Date(finishBy + "T12:00:00").toLocaleDateString() : "—");
      if (c) {
        const target = finishBy ? new Date(finishBy + "T23:59:59") : null;
        const targetDay = target ? new Date(target.getFullYear(), target.getMonth(), target.getDate(), 0, 0, 0, 0) : null;
        const days = targetDay ? Math.ceil((targetDay - today) / (24 * 60 * 60 * 1000)) : 0;
        if (c.left === 0) subtitle += " — DONE.";
        else if (days <= 0) subtitle += " — date passed.";
        else subtitle += " — complete " + (c.left / days).toFixed(2) + " per day (" + c.left + " left).";
      } else subtitle += ".";
      const card = document.createElement("div");
      card.className = "goal-card";
      card.innerHTML = '<div class="goal-info"><strong>' + escapeHtml(g.courseName || "—") + '</strong><span>' + escapeHtml(subtitle) + '</span></div><button type="button" class="goal-remove">Remove</button>';
      card.querySelector(".goal-remove").addEventListener("click", () => removeGoal(i));
      container.appendChild(card);
    });
  }

  function scoreToLetterCollege(scorePercent) {
    if (scorePercent == null || !Number.isFinite(scorePercent)) return null;
    const n = scorePercent;
    if (n >= 97) return "A+";
    if (n >= 93) return "A";
    if (n >= 90) return "A-";
    if (n >= 87) return "B+";
    if (n >= 83) return "B";
    if (n >= 80) return "B-";
    if (n >= 77) return "C+";
    if (n >= 73) return "C";
    if (n >= 70) return "C-";
    if (n >= 67) return "D+";
    if (n >= 63) return "D";
    if (n >= 60) return "D-";
    return "F";
  }

  function scoreToLetterStandard(scorePercent) {
    if (scorePercent == null || !Number.isFinite(scorePercent)) return null;
    const n = scorePercent;
    if (n >= 90) return "A";
    if (n >= 80) return "B";
    if (n >= 70) return "C";
    if (n >= 60) return "D";
    return "F";
  }

  function getGradeFormat() {
    try { return localStorage.getItem(GRADE_FORMAT_KEY) || "standard"; } catch (e) { return "standard"; }
  }
  function getScoreToLetter() {
    return getGradeFormat() === "college" ? scoreToLetterCollege : scoreToLetterStandard;
  }

  function fmtLocalTime(iso) {
    try {
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "—";
      return d.toLocaleString();
    } catch { return "—"; }
  }

  function safeNum(n) {
    return (typeof n === "number" && Number.isFinite(n)) ? n : null;
  }

  // Parse end date string like "6/1/26" or "2/1/26" (MM/D/YY)
  function parseEndDate(str) {
    if (!str || typeof str !== "string") return null;
    const parts = str.trim().split(/\s*\/\s*/);
    if (parts.length !== 3) return null;
    let month = parseInt(parts[0], 10);
    const day = parseInt(parts[1], 10);
    let year = parseInt(parts[2], 10);
    if (Number.isNaN(month) || Number.isNaN(day) || Number.isNaN(year)) return null;
    if (year < 100) year += 2000; // 26 -> 2026
    if (month < 1 || month > 12) return null;
    const d = new Date(year, month - 1, day, 23, 59, 59, 999);
    return Number.isNaN(d.getTime()) ? null : d;
  }

  function getDaysRemaining(endDateStr) {
    const end = parseEndDate(endDateStr);
    if (!end) return null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const endDay = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 0, 0, 0, 0);
    const ms = endDay - today;
    return Math.ceil(ms / (24 * 60 * 60 * 1000));
  }

  function getWeekdaysRemaining(endDateStr) {
    const end = parseEndDate(endDateStr);
    if (!end) return null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const endDay = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 0, 0, 0, 0);
    if (endDay < today) return 0;
    let count = 0;
    const d = new Date(today);
    const msPerDay = 24 * 60 * 60 * 1000;
    while (d <= endDay) {
      const day = d.getDay();
      if (day !== 0 && day !== 6) count++;
      d.setTime(d.getTime() + msPerDay);
    }
    return count;
  }

  let lastCourses = [];
  let lastRenderedData = null;
  let lastChartData = null;

  function setStatus(msg, isWarn=false) {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.className = isWarn ? "warn" : "";
  }

  async function loadData() {
    // cache-bust so refresh always reads the newest downloaded file
    const url = `${JSON_FILE}?t=${Date.now()}`;

    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) {
      throw new Error(`Couldn't load ${JSON_FILE} (HTTP ${res.status}). Make sure the file is in the same folder and you're using a local server.`);
    }
    return await res.json();
  }

  function render(data) {
    lastRenderedData = data;
    const last = data?.scrapedAt ? fmtLocalTime(data.scrapedAt) : "—";
    document.getElementById("lastUpdate").textContent = last;

    const courses = Array.isArray(data?.courses) ? data.courses : [];
    document.getElementById("numCourses").textContent = courses.length;

    let sumLeft = 0, sumTotal = 0, sumCompleted = 0;

    for (const c of courses) {
      const a = c.assignments;
      if (a && safeNum(a.total) != null && safeNum(a.completed) != null) {
        sumTotal += a.total;
        sumCompleted += a.completed;
        sumLeft += (safeNum(a.left) != null) ? a.left : (a.total - a.completed);
      }
    }

    document.getElementById("sumLeft").textContent = sumLeft.toString();
    document.getElementById("sumTotal").textContent = sumTotal.toString();

    lastChartData = {
      sumCompleted,
      sumTotal,
      sumLeft,
      courses: courses.map(c => {
        const a = c.assignments || null;
        const completed = a && safeNum(a.completed) != null ? a.completed : 0;
        const total = a && safeNum(a.total) != null ? a.total : 0;
        const left = a && safeNum(a.left) != null ? a.left : (total - completed);
        return { courseName: cleanText(c.course) || "—", left: left ?? 0 };
      })
    };

    const overallPct = sumTotal > 0 ? (sumCompleted / sumTotal) * 100 : null;
    document.getElementById("overallPct").textContent = (overallPct == null) ? "—" : `${overallPct.toFixed(2)}%`;

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    courses.forEach(c => {
      const course = cleanText(c.course);
      const endDate = cleanText(c.endDate);
      const score = safeNum(c.scorePercent);
      const progress = safeNum(c.progressPercent);

      const a = c.assignments || null;
      const completed = a && safeNum(a.completed) != null ? a.completed : null;
      const total = a && safeNum(a.total) != null ? a.total : null;
      const left = a && safeNum(a.left) != null ? a.left : (total != null && completed != null ? (total - completed) : null);

      const donePct = (total && completed != null) ? (completed / total) * 100
                    : (progress != null) ? progress
                    : null;

      const scoreToLetter = getScoreToLetter();
      const gradeStr = score == null ? "—" : (score.toFixed(2) + "%" + (scoreToLetter(score) ? " (" + scoreToLetter(score) + ")" : ""));
      const progressStr = progress == null ? "—" : (Number(progress).toFixed(2) + "%");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(course || "—")}</td>
        <td>${escapeHtml(endDate || "—")}</td>
        <td>${gradeStr}</td>
        <td>${progressStr}</td>
        <td>${(completed == null || total == null) ? "—" : `${completed} / ${total}`}</td>
        <td>${left == null ? "—" : left}</td>
        <td>
          <div class="bar"><div style="width:${donePct == null ? 0 : Math.max(0, Math.min(100, donePct)).toFixed(2)}%"></div></div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Per-day requirements
    lastCourses = [];
    const perDayBody = document.getElementById("perDayBody");
    perDayBody.innerHTML = "";
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    courses.forEach(c => {
      const courseName = cleanText(c.course);
      const endDateStr = cleanText(c.endDate);
      const a = c.assignments || null;
      const left = a && safeNum(a.left) != null ? a.left : (a && safeNum(a.total) != null && safeNum(a.completed) != null ? (a.total - a.completed) : null);
      const progress = safeNum(c.progressPercent);
      const daysRemaining = getDaysRemaining(endDateStr);
      const isDone = (left != null && left === 0) || (progress != null && progress >= 100) || (daysRemaining != null && daysRemaining <= 0);
      const perDayText = isDone ? "DONE" : (left != null && daysRemaining != null && daysRemaining > 0 ? (left / daysRemaining).toFixed(2) + " per day" : "—");

      lastCourses.push({ course: courseName, left: left ?? 0, endDate: endDateStr, progress });

      const daysLeft = getDaysRemaining(endDateStr);
      const weekdaysLeft = getWeekdaysRemaining(endDateStr);
      const showDone = (progress != null && progress >= 100) || (daysLeft != null && daysLeft <= 0);
      const daysLeftStr = showDone ? "DONE" : (daysLeft == null ? "—" : (daysLeft <= 0 ? "0" : String(daysLeft)));
      const weekdaysStr = showDone ? "DONE" : (weekdaysLeft == null ? "—" : String(weekdaysLeft));
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(courseName || "—")}</td><td>${daysLeftStr}</td><td>${weekdaysStr}</td><td>${escapeHtml(perDayText)}</td>`;
      perDayBody.appendChild(tr);
    });

    // Goals dropdown (for adding new goals)
    const goalSelect = document.getElementById("goalCourse");
    goalSelect.innerHTML = '<option value="">— Select course —</option>';
    lastCourses.forEach((c, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = c.course || "—";
      goalSelect.appendChild(opt);
    });

    renderGoalCards();
    saveToStorage(data);
  }

  function escapeHtml(s){
    return (s || "").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  const CHART_COLORS = ["#e91e63","#2196f3","#4caf50","#ff9800","#9c27b0","#00bcd4","#8bc34a","#795548","#607d8b","#f44336"];

  function renderCharts() {
    const d = lastChartData;
    const pie1 = document.getElementById("pieCompletedVsRemaining");
    const leg1 = document.getElementById("legendCompletedVsRemaining");
    const pie2 = document.getElementById("pieRemainingPerCourse");
    const leg2 = document.getElementById("legendRemainingPerCourse");
    if (!pie1 || !pie2) return;

    if (!d || d.sumTotal == null || d.sumTotal === 0) {
      pie1.style.background = "var(--bar-track)";
      leg1.innerHTML = "<span>No assignment data.</span>";
      pie2.style.background = "var(--bar-track)";
      leg2.innerHTML = "<span>No assignment data.</span>";
      return;
    }

    const pctCompleted = (d.sumCompleted / d.sumTotal) * 100;
    pie1.style.background = `conic-gradient(#4caf50 0% ${pctCompleted}%, #9e9e9e ${pctCompleted}% 100%)`;
    leg1.innerHTML = '<span><span class="dot" style="background:#4caf50"></span>Completed: ' + d.sumCompleted + '</span><span><span class="dot" style="background:#9e9e9e"></span>Remaining: ' + (d.sumTotal - d.sumCompleted) + '</span>';

    const withRemaining = d.courses.filter(c => c.left > 0);
    if (withRemaining.length === 0 || d.sumLeft === 0) {
      pie2.style.background = "#9e9e9e";
      leg2.innerHTML = "<span>No remaining assignments.</span>";
      return;
    }

    let gradientStops = [];
    let acc = 0;
    const totalRem = d.sumLeft;
    withRemaining.forEach((c, i) => {
      const pct = (c.left / totalRem) * 100;
      const color = CHART_COLORS[i % CHART_COLORS.length];
      gradientStops.push(color + " " + acc + "% " + (acc + pct) + "%");
      acc += pct;
    });
    pie2.style.background = "conic-gradient(" + gradientStops.join(", ") + ")";
    leg2.innerHTML = withRemaining.map((c, i) => {
      const pct = totalRem > 0 ? ((c.left / totalRem) * 100).toFixed(1) : "0";
      const color = CHART_COLORS[i % CHART_COLORS.length];
      return '<span><span class="dot" style="background:' + color + '"></span>' + escapeHtml(c.courseName) + ": " + pct + "%</span>";
    }).join("");
  }

  async function refresh() {
    try {
      setStatus("Loading…");
      const data = await loadData();
      render(data);
      setStatus("Loaded ✅");
    } catch (e) {
      console.error(e);
      const cached = loadFromStorage();
      if (cached) {
        render(cached);
        setStatus("Using last saved data (file unavailable)");
      } else {
        setStatus(e.message || "Failed to load.", true);
      }
    }
  }

  document.getElementById("refreshBtn").addEventListener("click", refresh);
  document.getElementById("addGoalBtn").addEventListener("click", addGoal);

  document.getElementById("tabDashboard").addEventListener("click", () => {
    document.getElementById("tabDashboard").classList.add("active");
    document.getElementById("tabCharts").classList.remove("active");
    document.getElementById("dashboardPanel").classList.remove("hidden");
    document.getElementById("chartsPanel").classList.add("hidden");
  });
  document.getElementById("tabCharts").addEventListener("click", () => {
    document.getElementById("tabCharts").classList.add("active");
    document.getElementById("tabDashboard").classList.remove("active");
    document.getElementById("chartsPanel").classList.remove("hidden");
    document.getElementById("dashboardPanel").classList.add("hidden");
    renderCharts();
  });

  const gradeFormatSelect = document.getElementById("gradeFormatSelect");
  if (gradeFormatSelect) {
    gradeFormatSelect.value = getGradeFormat();
    gradeFormatSelect.addEventListener("change", () => {
      try { localStorage.setItem(GRADE_FORMAT_KEY, gradeFormatSelect.value); } catch (e) {}
      if (lastRenderedData) render(lastRenderedData);
    });
  }

  // On open: try file first; if it fails, auto-refill from last saved data
  refresh();
</script>

</body>
</html>